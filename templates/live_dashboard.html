<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanlÄ± Dashboard - SayÄ±m Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.0/dist/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f5f5f5;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Ãœst Navigasyon BarÄ± */
        .top-nav {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e5e5e5;
        }

        .nav-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-title i {
            font-size: 28px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #dcfce7;
            color: #16a34a;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: #16a34a;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .nav-btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-back {
            background: #dc2626;
            color: white;
        }

        .btn-back:hover {
            background: #b91c1c;
            color: white;
        }

        /* Kartlar */
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e5e5e5;
        }

        .card-header-custom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e5e5;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            font-size: 22px;
        }

        /* Ä°statistik KartlarÄ± */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 992px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 576px) {
            .stats-row { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: #dc2626;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card.blue { background: #3b82f6; }
        .stat-card.green { background: #10b981; }
        .stat-card.orange { background: #f59e0b; }
        .stat-card.purple { background: #8b5cf6; }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            margin: 8px 0;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Progress Bar */
        .progress-section {
            margin: 25px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-title {
            font-weight: 600;
            color: #374151;
        }

        .progress-percent {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
        }

        .progress-bar-custom {
            background: #e5e7eb;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #dc2626, #ef4444);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        /* Ä°ki Kolon Layout */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 992px) {
            .two-column-layout { grid-template-columns: 1fr; }
        }

        /* Son Taramalar */
        .recent-scans-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recent-scans-list::-webkit-scrollbar {
            width: 8px;
        }

        .recent-scans-list::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .recent-scans-list::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 4px;
        }

        .scan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }

        .scan-item.duplicate {
            border-left-color: #f59e0b;
            background: #fefce8;
        }

        .scan-item.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .scan-info {
            flex: 1;
        }

        .scan-code {
            font-weight: 700;
            font-size: 15px;
            color: #1f2937;
        }

        .scan-name {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        .scan-time {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }

        /* SayÄ±m Ã–zeti */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .summary-card {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid #e5e5e5;
        }

        .summary-value {
            font-size: 36px;
            font-weight: 700;
        }

        .summary-value.ok { color: #10b981; }
        .summary-value.missing { color: #ef4444; }
        .summary-value.excess { color: #f59e0b; }

        .summary-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            margin-top: 5px;
        }

        /* Rapor Tablosu */
        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 15px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .report-table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table thead {
            background: #dc2626;
            color: white;
            position: sticky;
            top: 0;
        }

        .report-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 16px;
        }

        .report-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #e5e5e5;
            font-size: 16px;
            font-weight: 500;
        }

        .report-table td strong {
            font-size: 17px;
            font-weight: 700;
        }

        .report-table tbody tr:hover {
            background: #fef2f2;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
        }

        .badge-ok {
            background: #dcfce7;
            color: #16a34a;
        }

        .badge-missing {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-excess {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* SatÄ±r renkleri */
        .row-ok {
            background: #f0fdf4 !important;
        }

        .row-missing {
            background: #fffbeb !important;
        }

        .row-excess {
            background: #fef2f2 !important;
        }

        .row-pending {
            background: #f9fafb !important;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Ãœst Navigasyon -->
        <div class="top-nav">
            <div class="nav-left">
                <div class="nav-title">
                    <i class="bi bi-speedometer2"></i>
                    CanlÄ± Dashboard
                </div>
                <div class="live-indicator">
                    <span class="pulse-dot"></span>
                    CanlÄ± GÃ¼ncelleme
                </div>
            </div>
            <a href="#" id="backToScanner" class="nav-btn btn-back">
                <i class="bi bi-qr-code-scan"></i> Taramaya DÃ¶n
            </a>
        </div>

        <!-- SayÄ±m Bilgileri KartÄ± -->
        <div class="dashboard-card">
            <div class="card-header-custom">
                <div class="card-title">
                    <i class="bi bi-clipboard-check"></i>
                    SayÄ±m Bilgileri
                </div>
                <div id="sessionName" style="font-size: 16px; font-weight: 600; color: #6b7280;">-</div>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">BEKLENEN</div>
                    <div class="stat-value" id="expectedCount">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">SAYILAN</div>
                    <div class="stat-value" id="scannedCount">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">KALAN</div>
                    <div class="stat-value" id="remaining">0</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">SÃœRE</div>
                    <div class="stat-value" id="sessionDuration" style="font-size: 28px;">0s 0dk</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-title">SayÄ±m Ä°lerlemesi</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Ä°ki Kolonlu BÃ¶lÃ¼m -->
        <div class="two-column-layout">
            <!-- Son Taramalar -->
            <div class="dashboard-card">
                <div class="card-header-custom">
                    <div class="card-title">
                        <i class="bi bi-clock-history"></i>
                        Son Taramalar
                    </div>
                </div>
                <div class="recent-scans-list" id="recentScans">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>HenÃ¼z tarama yapÄ±lmadÄ±</p>
                    </div>
                </div>
            </div>

            <!-- SayÄ±m Ã–zeti -->
            <div class="dashboard-card">
                <div class="card-header-custom">
                    <div class="card-title">
                        <i class="bi bi-pie-chart-fill"></i>
                        SayÄ±m Ã–zeti
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-value ok" id="okCount">0</div>
                        <div class="summary-label">âœ“ Tamam</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value missing" id="missingCount">0</div>
                        <div class="summary-label">âœ— Eksik</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value excess" id="excessCount">0</div>
                        <div class="summary-label">âš  Fazla</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SayÄ±m Raporu -->
        <div class="dashboard-card">
            <div class="card-header-custom">
                <div class="card-title">
                    <i class="bi bi-table"></i>
                    SayÄ±m Raporu
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="reportSearch" placeholder="ðŸ” ParÃ§a kodu veya adÄ± ile ara..." onkeyup="filterReport()">
            </div>
            <div class="report-table-container">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>ParÃ§a Kodu</th>
                            <th>Beklenen</th>
                            <th>SayÄ±lan</th>
                            <th>Fark</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <i class="bi bi-hourglass-split"></i>
                                    <p>Rapor yÃ¼kleniyor...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const sessionId = new URLSearchParams(window.location.search).get('session_id');
        let socket = null;
        let reportData = [];
        let recentScansData = [];
        
        if (!sessionId) {
            console.error('Session ID bulunamadÄ±!');
            alert('Session ID bulunamadÄ±! LÃ¼tfen scanner sayfasÄ±ndan dashboard butonuna tÄ±klayÄ±n.');
        } else {
            console.log('Session ID:', sessionId);
            document.getElementById('backToScanner').href = '/scanner?session_id=' + sessionId;
        }
        
        function initSocket() {
            socket = io();
            socket.on('connect', function() { 
                console.log('Socket.IO baÄŸlandÄ±'); 
            });
            socket.on('scan_result', function(data) {
                console.log('Yeni tarama:', data);
                updateDashboard();
            });
        }
        
        function renderRecentScans() {
            const container = document.getElementById('recentScans');
            if (recentScansData.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>HenÃ¼z tarama yapÄ±lmadÄ±</p></div>';
                return;
            }
            container.innerHTML = recentScansData.map(function(scan) {
                let statusClass = '';
                if (scan.duplicate) statusClass = 'duplicate';
                if (!scan.success) statusClass = 'error';
                return '<div class="scan-item ' + statusClass + '">' +
                    '<div class="scan-info">' +
                        '<div class="scan-code">' + scan.code + '</div>' +
                        '<div class="scan-name">' + scan.message + '</div>' +
                    '</div>' +
                    '<div class="scan-time">' + scan.time + '</div>' +
                '</div>';
            }).join('');
        }
        
        async function updateDashboard() {
            if (!sessionId) return;
            try {
                // Aktif session bilgisi
                const sessionRes = await fetch('/api/get_active_count_session');
                const sessionData = await sessionRes.json();
                if (sessionData.active_session) {
                    const session = sessionData.active_session;
                    document.getElementById('sessionName').textContent = session.session_name || '-';
                    if (session.started_at) {
                        const startTime = new Date(session.started_at);
                        const now = new Date();
                        const diffMs = now - startTime;
                        const hours = Math.floor(diffMs / 3600000);
                        const mins = Math.floor((diffMs % 3600000) / 60000);
                        document.getElementById('sessionDuration').textContent = hours + 's ' + mins + 'dk';
                    }
                }
                
                // Rapor verisi
                const reportRes = await fetch('/api/get_session_report/' + sessionId);
                const reportJson = await reportRes.json();
                
                if (reportJson.success) {
                    reportData = reportJson.report || reportJson.items || [];
                    const totalExpected = reportJson.total_expected || 0;
                    const totalScanned = reportJson.total_scanned || 0;
                    
                    document.getElementById('expectedCount').textContent = totalExpected;
                    document.getElementById('scannedCount').textContent = totalScanned;
                    
                    const remaining = Math.max(0, totalExpected - totalScanned);
                    document.getElementById('remaining').textContent = remaining;
                    
                    const progress = totalExpected > 0 ? Math.round((totalScanned / totalExpected) * 100) : 0;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressPercent').textContent = progress + '%';
                    
                    let okCount = 0, missingCount = 0, excessCount = 0;
                    reportData.forEach(function(item) {
                        const diff = (item.scanned || 0) - (item.expected || 0);
                        if (diff === 0 && item.scanned > 0) okCount++;
                        else if (diff < 0) missingCount++;
                        else if (diff > 0) excessCount++;
                    });
                    
                    document.getElementById('okCount').textContent = okCount;
                    document.getElementById('missingCount').textContent = missingCount;
                    document.getElementById('excessCount').textContent = excessCount;
                    
                    renderReport();
                }
                
                // Son taramalar
                const scansRes = await fetch('/api/get_recent_scans/' + sessionId);
                const scansJson = await scansRes.json();
                if (scansJson.success && scansJson.scans) {
                    recentScansData = scansJson.scans.map(function(s) {
                        return {
                            code: s.part_code || s.qr_code || 'Bilinmiyor',
                            message: s.part_name || '',
                            success: true,
                            duplicate: s.is_duplicate || false,
                            time: s.scanned_at || ''
                        };
                    });
                    renderRecentScans();
                }
            } catch (error) {
                console.error('Dashboard gÃ¼ncelleme hatasÄ±:', error);
            }
        }
        
        function renderReport() {
            const tbody = document.getElementById('reportTableBody');
            const searchText = document.getElementById('reportSearch').value.toLowerCase();
            
            let filtered = reportData;
            if (searchText) {
                filtered = reportData.filter(function(item) {
                    return (item.part_code || '').toLowerCase().includes(searchText) || 
                           (item.part_name || '').toLowerCase().includes(searchText);
                });
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="bi bi-search"></i><p>Veri bulunamadÄ±</p></div></td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(function(item) {
                const expected = item.expected || 0;
                const scanned = item.scanned || 0;
                const diff = scanned - expected;
                let badgeClass = 'badge-pending';
                let rowClass = 'row-pending';
                let statusText = 'â³ Bekliyor';
                
                if (diff === 0 && scanned > 0) { 
                    badgeClass = 'badge-ok'; 
                    rowClass = 'row-ok';
                    statusText = 'âœ“ Tamam'; 
                } else if (diff > 0) { 
                    badgeClass = 'badge-excess'; 
                    rowClass = 'row-excess';
                    statusText = 'âœ— Fazla'; 
                } else if (diff < 0 && scanned > 0) { 
                    badgeClass = 'badge-missing'; 
                    rowClass = 'row-missing';
                    statusText = 'âš  Eksik'; 
                } else if (diff < 0 && scanned === 0) {
                    badgeClass = 'badge-missing'; 
                    rowClass = 'row-missing';
                    statusText = 'âš  SayÄ±lmadÄ±'; 
                }
                
                return '<tr class="' + rowClass + '">' +
                    '<td><strong>' + (item.part_code || '-') + '</strong></td>' +
                    '<td>' + expected + '</td>' +
                    '<td>' + scanned + '</td>' +
                    '<td>' + (diff > 0 ? '+' : '') + diff + '</td>' +
                    '<td><span class="status-badge ' + badgeClass + '">' + statusText + '</span></td>' +
                '</tr>';
            }).join('');
        }
        
        function filterReport() { 
            renderReport(); 
        }
        
        console.log('Dashboard baÅŸlatÄ±lÄ±yor...');
        initSocket();
        updateDashboard();
        setInterval(updateDashboard, 3000);
    </script>
</body>
</html>
