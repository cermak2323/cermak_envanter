<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈ü Hƒ±zlƒ± Ekleme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #f5f5f5;
            padding-top: 1rem;
        }
        .header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .section-card {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary-action {
            background: #dc2626;
            color: white;
            border: none;
        }
        .btn-primary-action:hover {
            background: #b91c1c;
            color: white;
        }
        .list-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .list-item:hover {
            background: #f9fafb;
            border-color: #dc2626;
        }
        .list-item.active {
            background: #fee2e2;
            border-color: #dc2626;
            border-width: 2px;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .table thead {
            position: sticky;
            top: 0;
            background: #dc2626;
            color: white;
        }
        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .total-section {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid #dc2626;
        }
        .excel-row-success {
            background: #dcfce7;
        }
        .excel-row-error {
            background: #fee2e2;
        }
        #excelPreviewSection {
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h2><i class="bi bi-lightning-fill"></i> Sipari≈ü Hƒ±zlƒ± Ekleme</h2>
            <p>Mevcut sipari≈üleri se√ßip, par√ßalarƒ± hƒ±zlƒ±ca kopyala veya ekle</p>
        </div>
    </div>

    <div class="container">
        <!-- 0. EXCEL Y√úKLEME - YENƒ∞ PAR√áALAR EKLE -->
        <div class="section-card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-left: 4px solid #16a34a;">
            <h4><i class="bi bi-file-earmark-excel"></i> Excel'den Hƒ±zlƒ± Sipari≈ü Ekle</h4>
            <p class="text-muted mb-3">
                <small>Excel dosyasƒ±nda <strong>Par√ßa Kodu</strong> ve <strong>Adet</strong> s√ºtunlarƒ± olmalƒ±dƒ±r. 
                Par√ßa adlarƒ± otomatik √ßekilecektir. <a href="sample_order.xlsx" download="sample_order.xlsx">
                <i class="bi bi-download"></i> √ñrnek dosyayƒ± indir</a></small>
            </p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">üìÑ Excel Dosyasƒ± Se√ß</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls,.csv" 
                               onchange="handleExcelUpload(event)">
                        <small class="text-muted d-block mt-2">Desteklenen: .xlsx, .xls, .csv</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="excelListName" class="form-label">Sipari≈ü Listesi Adƒ±</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="excelListName" placeholder="√ñrn: CER2025001">
                            <button class="btn btn-outline-success" type="button" onclick="generateListName()">
                                <i class="bi bi-arrow-repeat"></i> Olu≈ütur
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="excelPreviewSection" style="display:none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 1.5rem; border-radius: 8px;">
                <h5><i class="bi bi-eye"></i> √ñn ƒ∞zleme</h5>
                <p class="text-muted mb-3">A≈üaƒüƒ±daki par√ßalar sipari≈ülere eklenecektir:</p>
                
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-3 table-hover">
                        <thead class="table-light" style="position: sticky; top: 0;">
                            <tr>
                                <th style="width: 20%;">
                                    <i class="bi bi-box"></i> Par√ßa Kodu
                                </th>
                                <th style="width: 35%;">
                                    <i class="bi bi-file-text"></i> Par√ßa Adƒ±
                                </th>
                                <th style="width: 15%;">
                                    <i class="bi bi-hash"></i> Adet
                                </th>
                                <th style="width: 30%;">
                                    <i class="bi bi-check-circle"></i> Durum
                                </th>
                            </tr>
                        </thead>
                        <tbody id="excelPreviewTable">
                        </tbody>
                    </table>
                </div>
                
                <div class="alert mb-3" id="excelValidationMsg" role="alert" style="margin: 0;"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button class="btn btn-outline-secondary" onclick="resetExcelForm()">
                        <i class="bi bi-arrow-clockwise"></i> Ba≈üa D√∂n
                    </button>
                    <button class="btn btn-success btn-lg" id="addExcelButton" onclick="addExcelToOrders()" style="display:none; padding: 0.75rem 2rem;">
                        <i class="bi bi-check-circle-fill"></i> Sipari≈ülere Ekle
                    </button>
                </div>
            </div>
        </div>

        <!-- 1. MEVCUT Sƒ∞PARƒ∞≈ûLER -->
        <div class="section-card">
            <h4><i class="bi bi-list-check"></i> Adƒ±m 1: Mevcut Sipari≈üleri Se√ß</h4>
            <p class="text-muted">A≈üaƒüƒ±daki sipari≈ülerden birini se√ßerek par√ßalarƒ±nƒ± g√∂rebilirsiniz.</p>
            
            <div id="loadingDiv" style="display:none;" class="text-center py-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Y√ºkleniyor...</span>
                </div>
                <p>Sipari≈üler y√ºkleniyor...</p>
            </div>

            <div id="noListsDiv" style="display:none;" class="alert alert-info">
                <i class="bi bi-info-circle"></i> Hen√ºz sipari≈üli par√ßa yok.
            </div>

            <div id="listsDiv" style="display:none;">
                <div id="listContainer"></div>
            </div>
        </div>

        <!-- 2. SE√áƒ∞Lƒ∞ Sƒ∞PARƒ∞≈ûƒ∞N PAR√áALARI -->
        <div class="section-card" id="detailSection" style="display:none;">
            <h4><i class="bi bi-basket"></i> Adƒ±m 2: Sipari≈ü Detaylarƒ± - <span id="selectedListName"></span></h4>
            <p class="text-muted" id="selectedListInfo"></p>
            
            <div class="table-container">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Par√ßa Kodu</th>
                            <th>Par√ßa Adƒ±</th>
                            <th>Miktarƒ±</th>
                            <th>Birim Fiyat (‚Ç¨)</th>
                            <th>Toplam (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="partsTableBody">
                    </tbody>
                </table>
            </div>

            <div class="total-section">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Toplam Par√ßa:</strong> <span id="totalParts">0</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Toplam Fiyat:</strong> <span id="totalPrice">0.00</span> ‚Ç¨
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ƒ∞≈ûLEM SE√á -->
        <div class="section-card" id="actionSection" style="display:none;">
            <h4><i class="bi bi-tools"></i> Adƒ±m 3: Ne Yapmak ƒ∞stiyorsun?</h4>
            
            <div class="row">
                <div class="col-md-6 mb-2">
                    <button class="btn btn-primary-action w-100" onclick="showCopyOption()">
                        <i class="bi bi-clipboard"></i> Bu Sipari≈üi Kopyala (Aynƒ± Par√ßalarƒ± Yeni Sipari≈ü Yap)
                    </button>
                </div>
                <div class="col-md-6 mb-2">
                    <button class="btn btn-primary-action w-100" onclick="showAddToExisting()">
                        <i class="bi bi-plus-circle"></i> Par√ßalarƒ± Ba≈üka Listeye Ekle
                    </button>
                </div>
            </div>

            <!-- Kopyala Se√ßeneƒüi -->
            <div id="copySection" style="display:none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <h5>Yeni Sipari≈ü Adƒ± (Veya Bo≈ü Bƒ±rak - Otomatik Olu≈üturulsun):</h5>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="newListName" placeholder="√ñrn: CER2025001">
                    <button class="btn btn-success" onclick="copyOrder()">
                        <i class="bi bi-check-circle"></i> Kopyala
                    </button>
                </div>
            </div>

            <!-- Ba≈üka Listeye Ekle -->
            <div id="addToExistingSection" style="display:none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <h5>Hangi Listeye Eklemek ƒ∞stiyorsun?</h5>
                <select class="form-select mb-3" id="targetListSelect">
                    <option value="">-- Se√ß --</option>
                </select>
                <button class="btn btn-success" onclick="addToExistingList()">
                    <i class="bi bi-plus-circle"></i> Ekle
                </button>
            </div>
        </div>

        <!-- Debug -->
        <div class="section-card" style="background: #f9fafb; border-left: 4px solid #dc2626;">
            <h6><i class="bi bi-bug"></i> Durum</h6>
            <small id="debugInfo" style="font-family: monospace; color: #666;">Sistem hazƒ±rlanƒ±yor...</small>
        </div>
    </div>

    <script>
        let orderLists = {};
        let selectedListName = null;
        let selectedListItems = [];
        let excelData = [];  // Excel'den okunan veriler

        // Sayfayƒ± ba≈ülat
        window.onload = function() {
            updateDebug('Sipari≈ü listesi y√ºkleniyor...');
            loadOrderLists();
        };

        // ============================================================================
        // EXCEL Y√úKLEME FONKSƒ∞YONLARI
        // ============================================================================

        // Excel dosyasƒ±nƒ± y√ºkle ve oku
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(worksheet);

                    console.log('üìä Excel satƒ±rlarƒ±:', rows);

                    // Verileri i≈üle
                    processExcelData(rows);
                    updateDebug('‚úÖ Excel dosyasƒ± y√ºklendi');
                } catch (error) {
                    updateDebug('‚ùå Excel hatasƒ±: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Excel verilerini i≈üle
        function processExcelData(rows) {
            excelData = [];
            const previewTable = document.getElementById('excelPreviewTable');
            previewTable.innerHTML = '';

            if (!rows || rows.length === 0) {
                document.getElementById('excelValidationMsg').innerHTML = 
                    '<strong>‚ùå Hata:</strong> Excel dosyasƒ±nda veri bulunamadƒ±. Dosyayƒ± kontrol edin.';
                document.getElementById('excelValidationMsg').className = 'alert alert-danger';
                document.getElementById('excelPreviewSection').style.display = 'block';
                return;
            }

            let validCount = 0;

            rows.forEach((row, idx) => {
                // Par√ßa Kodu s√ºtununu bul (Case-insensitive)
                const partCodeKey = Object.keys(row).find(k => k.toLowerCase().includes('par√ßa kodu') || k.toLowerCase().includes('kod') || k.toLowerCase().includes('part'));
                // Adet s√ºtununu bul
                const quantityKey = Object.keys(row).find(k => k.toLowerCase().includes('adet') || k.toLowerCase().includes('quantity') || k.toLowerCase().includes('miktar') || k.toLowerCase().includes('qty'));

                const partCode = row[partCodeKey]?.toString().trim();
                const quantity = parseInt(row[quantityKey]) || 0;

                if (!partCode || quantity <= 0) {
                    return; // Ge√ßersiz satƒ±rƒ± atla
                }

                excelData.push({
                    part_code: partCode,
                    quantity: quantity,
                    part_name: '',  // Bo≈ü ba≈üla, API'den √ßekilecek
                    status: 'üîÑ Kontrol ediliyor...'
                });

                validCount++;
            });

            console.log('üìù ƒ∞≈ülenen par√ßalar:', excelData);

            if (validCount === 0) {
                document.getElementById('excelValidationMsg').innerHTML = 
                    '<strong>‚ùå Hata:</strong> Excel dosyasƒ±nda ge√ßerli par√ßa bulunamadƒ±. "Par√ßa Kodu" ve "Adet" s√ºtunlarƒ± kontrol edin.';
                document.getElementById('excelValidationMsg').className = 'alert alert-danger';
                document.getElementById('excelPreviewSection').style.display = 'block';
                return;
            }

            // Ba≈ülangƒ±√ß mesajƒ±nƒ± g√∂ster
            document.getElementById('excelValidationMsg').innerHTML = `<strong>‚è≥ ${validCount} par√ßa kontrol ediliyor...</strong>`;
            document.getElementById('excelValidationMsg').className = 'alert alert-info';
            document.getElementById('excelPreviewSection').style.display = 'block';

            // Par√ßa bilgilerini API'den √ßek
            fetchPartDetailsFromExcel();
        }

        // Excel'deki par√ßalarƒ±n bilgilerini API'den √ßek
        async function fetchPartDetailsFromExcel() {
            const previewTable = document.getElementById('excelPreviewTable');
            previewTable.innerHTML = '';

            let validParts = 0;
            let invalidParts = 0;

            for (let item of excelData) {
                try {
                    const response = await fetch(`/order_system/api/get_part_info/${item.part_code}`);
                    const data = await response.json();

                    if (data.success && data.part) {
                        item.part_name = data.part.part_name;
                        item.supplier = data.part.supplier;
                        item.unit_price = data.part.unit_price || 0;
                        item.status = '‚úÖ Bulundu';
                        validParts++;
                    } else {
                        item.status = '‚ùå Bulunamadƒ±';
                        invalidParts++;
                    }
                } catch (error) {
                    item.status = '‚ùå Hata: ' + error.message;
                    invalidParts++;
                }

                // √ñn izlemede g√∂ster
                const row = previewTable.insertRow();
                const statusColor = item.status.includes('‚úÖ') ? '#dcfce7' : '#fee2e2';
                row.style.background = statusColor;
                row.innerHTML = `
                    <td><strong>${item.part_code}</strong></td>
                    <td>${item.part_name || '-'} ${item.supplier ? `<br/><small class="text-muted">${item.supplier}</small>` : ''}</td>
                    <td><strong>${item.quantity}</strong></td>
                    <td>${item.status}</td>
                `;
            }

            // Sonu√ß mesajƒ±
            let msgHtml = '';
            if (validParts === 0 && invalidParts === 0) {
                msgHtml = '<strong>‚ö†Ô∏è Uyarƒ±:</strong> Excel dosyasƒ±nda ge√ßerli veri bulunamadƒ±. "Par√ßa Kodu" ve "Adet" s√ºtunlarƒ± kontrol edin.';
            } else if (validParts === 0) {
                msgHtml = `<strong>‚ùå Hata:</strong> ${invalidParts} par√ßa bulunamadƒ±. Par√ßa kodlarƒ±nƒ± kontrol edin.`;
            } else {
                msgHtml = `<strong>‚úÖ ${validParts} par√ßa bulundu</strong>${invalidParts > 0 ? `, ${invalidParts} bulunamadƒ±` : ', t√ºm√º hazƒ±r!'}`;
            }

            document.getElementById('excelValidationMsg').innerHTML = msgHtml;
            const msgElement = document.getElementById('excelValidationMsg');
            if (validParts === 0) {
                msgElement.className = 'alert alert-danger';
            } else if (invalidParts > 0) {
                msgElement.className = 'alert alert-warning';
            } else {
                msgElement.className = 'alert alert-success';
            }

            document.getElementById('excelPreviewSection').style.display = 'block';

            // Ekle butonunu g√∂ster eƒüer ge√ßerli par√ßalar varsa
            if (validParts > 0) {
                document.getElementById('addExcelButton').style.display = 'block';
            }
        }

        // Excel formunu sƒ±fƒ±rla
        function resetExcelForm() {
            document.getElementById('excelFile').value = '';
            document.getElementById('excelListName').value = '';
            document.getElementById('excelPreviewSection').style.display = 'none';
            document.getElementById('addExcelButton').disabled = false;
            document.getElementById('addExcelButton').style.display = 'none';
            excelData = [];
            updateDebug('Excel formu temizlendi');
        }

        // Otomatik liste adƒ± olu≈ütur
        function generateListName() {
            const now = new Date();
            const year = now.getFullYear();
            const random = Math.floor(Math.random() * 900) + 100;
            const listName = `CER${year}${String(random).padStart(3, '0')}`;
            document.getElementById('excelListName').value = listName;
        }

        // Excel verilerini sipari≈ü listesine ekle
        async function addExcelToOrders() {
            const listName = document.getElementById('excelListName').value.trim();
            if (!listName) {
                updateDebug('‚ùå Sipari≈ü listesi adƒ± bo≈ü olamaz');
                alert('L√ºtfen sipari≈ü listesi adƒ± girin veya "Otomatik Olu≈ütur" tu≈üuna tƒ±klayƒ±n');
                return;
            }

            // Sadece ge√ßerli par√ßalarƒ± filtrele
            const validItems = excelData.filter(item => item.status.includes('‚úÖ'));

            if (validItems.length === 0) {
                updateDebug('‚ùå Eklenecek ge√ßerli par√ßa yok');
                alert('Eklenecek ge√ßerli par√ßa bulunamadƒ±. L√ºtfen Excel dosyasƒ±nƒ± kontrol edin.');
                return;
            }

            try {
                document.getElementById('addExcelButton').disabled = true;
                updateDebug('‚è≥ Par√ßalar ekleniyor...');

                const response = await fetch('/order_system/api/add_manual_orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        list_name: listName,
                        items: validItems.map(item => ({
                            part_code: item.part_code,
                            part_name: item.part_name,
                            supplier: item.supplier,
                            quantity: item.quantity,
                            unit_price: item.unit_price,
                            total_price: item.quantity * item.unit_price
                        }))
                    })
                });

                const data = await response.json();

                if (data.success) {
                    updateDebug(`‚úÖ ${data.orders_created} par√ßa "${listName}" listesine eklendi`);
                    alert(`‚úÖ Ba≈üarƒ±lƒ±!\n${data.orders_created} par√ßa "${listName}" listesine eklendi.`);
                    
                    // Formu temizle
                    resetExcelForm();

                    // Sipari≈ü listesini yenile
                    loadOrderLists();
                } else {
                    updateDebug('‚ùå Hata: ' + (data.error || 'Bilinmeyen hata'));
                    alert('‚ùå Hata: ' + (data.error || 'Bilinmeyen hata'));
                    document.getElementById('addExcelButton').disabled = false;
                }
            } catch (error) {
                updateDebug('‚ùå Hata: ' + error.message);
                alert('‚ùå Hata: ' + error.message);
                document.getElementById('addExcelButton').disabled = false;
            }
        }

        // Mevcut sipari≈üleri y√ºkle
        async function loadOrderLists() {
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('listsDiv').style.display = 'none';
            document.getElementById('noListsDiv').style.display = 'none';

            try {
                const response = await fetch('/order_system/api/get_order_lists');
                const data = await response.json();

                if (data.success && data.order_lists) {
                    orderLists = data.order_lists;
                    displayLists();
                    loadTargetLists();
                    updateDebug('‚úÖ Sipari≈üler y√ºklendi');
                } else {
                    document.getElementById('noListsDiv').style.display = 'block';
                    updateDebug('‚ö†Ô∏è Sipari≈üli par√ßa yok');
                }
            } catch (error) {
                updateDebug('‚ùå Hata: ' + error.message);
            } finally {
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        // Sipari≈üleri g√∂ster
        function displayLists() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';

            Object.keys(orderLists).forEach(supplier => {
                Object.keys(orderLists[supplier]).forEach(listName => {
                    const listData = orderLists[supplier][listName];
                    // API obje d√∂nd√ºr√ºyor: { orders: [], order_date, total_amount }
                    const items = Array.isArray(listData) ? listData : (listData.orders || []);
                    const itemCount = items.length;
                    const totalPrice = items.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0);

                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.onclick = () => selectList(listName, supplier, items);
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${supplier}</strong><br>
                                <small class="text-muted">${listName}</small>
                            </div>
                            <div class="text-end">
                                <div><strong>${itemCount}</strong> par√ßa</div>
                                <small class="text-muted">${totalPrice.toFixed(2)} ‚Ç¨</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });

            document.getElementById('listsDiv').style.display = 'block';
        }

        // Sipari≈ü se√ß
        function selectList(listName, supplier, items) {
            // API obje d√∂nd√ºr√ºyor, items parametresi obje olabilir
            const actualItems = Array.isArray(items) ? items : (items.orders || []);
            
            selectedListName = listName;
            selectedListItems = actualItems;

            // UI g√ºncelle
            document.querySelectorAll('.list-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            displayListDetails(listName, supplier, actualItems);
            showActionSection();
            updateDebug(`‚úÖ "${listName}" se√ßildi (${actualItems.length} par√ßa)`);
        }

        // Sipari≈ü detaylarƒ±nƒ± g√∂ster
        function displayListDetails(listName, supplier, items) {
            // API obje d√∂nd√ºr√ºyor, items parametresi obje olabilir
            const actualItems = Array.isArray(items) ? items : (items.orders || []);
            
            document.getElementById('selectedListName').textContent = `${supplier} - ${listName}`;
            const totalAmount = actualItems.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0);
            document.getElementById('selectedListInfo').textContent = `${actualItems.length} par√ßa, Toplam: ${totalAmount.toFixed(2)} ‚Ç¨`;

            const tbody = document.getElementById('partsTableBody');
            tbody.innerHTML = '';

            let totalParts = 0;
            let totalPrice = 0;

            actualItems.forEach(item => {
                const row = document.createElement('tr');
                const qty = parseInt(item.quantity) || 0;
                const price = parseFloat(item.unit_price) || 0;
                const total = qty * price;

                totalParts += qty;
                totalPrice += total;

                row.innerHTML = `
                    <td><strong>${item.part_code}</strong></td>
                    <td>${item.part_name || '-'}</td>
                    <td>${qty}</td>
                    <td>${price.toFixed(2)}</td>
                    <td>${total.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('totalParts').textContent = totalParts;
            document.getElementById('totalPrice').textContent = totalPrice.toFixed(2);
            document.getElementById('detailSection').style.display = 'block';
        }

        // ƒ∞≈ülem se√ßeneklerini g√∂ster
        function showActionSection() {
            document.getElementById('actionSection').style.display = 'block';
            document.getElementById('copySection').style.display = 'none';
            document.getElementById('addToExistingSection').style.display = 'none';
        }

        // Kopyala se√ßeneƒüini g√∂ster
        function showCopyOption() {
            document.getElementById('copySection').style.display = 'block';
            document.getElementById('addToExistingSection').style.display = 'none';
        }

        // Ba≈üka Listeye Ekle se√ßeneƒüini g√∂ster
        function showAddToExisting() {
            document.getElementById('copySection').style.display = 'none';
            document.getElementById('addToExistingSection').style.display = 'block';
        }

        // Hedef listeleri y√ºkle
        async function loadTargetLists() {
            const select = document.getElementById('targetListSelect');
            
            Object.keys(orderLists).forEach(supplier => {
                Object.keys(orderLists[supplier]).forEach(listName => {
                    if (listName !== selectedListName) {
                        const option = document.createElement('option');
                        option.value = listName;
                        option.textContent = `${supplier} - ${listName}`;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Sipari≈üi kopyala
        async function copyOrder() {
            if (!selectedListItems || selectedListItems.length === 0) {
                alert('L√ºtfen bir sipari≈ü se√ßin');
                return;
            }

            const newListName = document.getElementById('newListName').value || selectedListName + '_KOPYASI_' + new Date().getTime();

            if (!newListName) {
                alert('L√ºtfen sipari≈ü adƒ± girin');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Kopyalanƒ±yor...';

            try {
                const response = await fetch('/order_system/api/add_manual_orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        list_name: newListName,
                        items: selectedListItems
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Ba≈üarƒ±lƒ±!\n"${newListName}" adƒ±yla yeni sipari≈ü olu≈üturuldu.`);
                    await loadOrderLists();
                    document.getElementById('newListName').value = '';
                    showActionSection();
                } else {
                    alert('‚ùå Hata: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Baƒülantƒ± hatasƒ±: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚úÖ Kopyala';
            }
        }

        // Ba≈üka Listeye Ekle
        async function addToExistingList() {
            if (!selectedListItems || selectedListItems.length === 0) {
                alert('L√ºtfen bir sipari≈ü se√ßin');
                return;
            }

            const targetList = document.getElementById('targetListSelect').value;
            if (!targetList) {
                alert('L√ºtfen hedef listeyi se√ßin');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Ekleniyor...';

            try {
                const response = await fetch('/order_system/api/add_manual_orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        list_name: targetList,
                        items: selectedListItems
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Ba≈üarƒ±lƒ±!\n${data.orders_created} par√ßa "${targetList}" listesine eklendi.`);
                    await loadOrderLists();
                    showActionSection();
                } else {
                    alert('‚ùå Hata: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Baƒülantƒ± hatasƒ±: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚úÖ Ekle';
            }
        }

        // Debug
        function updateDebug(msg) {
            document.getElementById('debugInfo').textContent = new Date().toLocaleTimeString() + ' - ' + msg;
        }
    </script>
</body>
</html>
